<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Viscometer Control</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    /* Dark Theme (Default) */
    --bg-body: #0f172a;
    --bg-card: #1e293b;
    --bg-surface: #334155;
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --border: #334155;
    
    --primary: #3b82f6;
    --primary-hover: #2563eb;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    
    --btn-bg: #334155;
    --btn-text: #f8fafc;
    --input-bg: #0f172a;
    
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  /* Light Theme */
  .light {
    --bg-body: #f1f5f9;
    --bg-card: #ffffff;
    --bg-surface: #e2e8f0;
    --text-main: #0f172a;
    --text-muted: #64748b;
    --border: #cbd5e1;
    
    --primary: #2563eb;
    --primary-hover: #1d4ed8;
    
    --btn-bg: #ffffff;
    --btn-text: #334155;
    --input-bg: #f8fafc;
    
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--bg-body);
    color: var(--text-main);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    transition: background-color 0.3s;
  }

  /* --- RESPONSIVE LAYOUT --- */
  .wrap { 
    max-width: 1200px; 
    margin: 0 auto; 
    padding: 20px; 
  }
  
  @media (max-width: 768px) {
    .wrap { padding: 12px; } /* Less padding on mobile */
  }
  
  /* Header */
  header {
    display: flex; justify-content: space-between; align-items: center;
    padding-bottom: 20px; margin-bottom: 20px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap; /* Allow wrapping on small screens */
    gap: 16px;
  }
  
  .brand { display: flex; flex-direction: column; }
  .brand-row { display: flex; align-items: center; }
  .brand h1 { margin: 0; font-size: 20px; font-weight: 700; white-space: nowrap; }
  .badge { 
    font-size: 10px; font-weight: 700; text-transform: uppercase; 
    background: var(--primary); color: white; padding: 3px 6px; 
    border-radius: 4px; margin-left: 8px; 
  }
  .subtitle { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
  
  .controls-top { display: flex; gap: 12px; align-items: center; }

  /* MEDIA QUERY: Small Mobile Header */
  @media (max-width: 480px) {
    header {
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
    }
    
    .controls-top {
      width: 100%;
      justify-content: space-between;
    }
    
    .brand h1 {
      font-size: 18px; /* Slightly smaller on very small screens */
    }
  }

  /* Main Grid System */
  .main-grid {
    display: grid;
    grid-template-columns: 1fr 340px; /* Sidebar is fixed width on desktop */
    gap: 24px;
  }

  /* MEDIA QUERY: Tablet & Mobile Switch */
  @media (max-width: 900px) {
    .main-grid {
      grid-template-columns: 1fr; /* Stack into single column */
    }
    
    header {
      align-items: flex-start;
    }
    .controls-top {
      width: 100%;
      justify-content: space-between; /* Spread status and theme button */
    }
  }

  /* Cards */
  .card {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 20px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    margin-bottom: 24px;
  }
  @media (max-width: 480px) {
    .card { padding: 16px; } /* More compact on phones */
  }

  .card-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);
  }
  .card-title { font-weight: 600; font-size: 15px; display: flex; align-items: center; gap: 8px; }

  /* Big Stats Grid */
  .stats-row { 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 16px; 
    margin-bottom: 24px; 
  }
  @media (max-width: 600px) {
    .stats-row { grid-template-columns: 1fr; gap: 12px; } /* Stack stats vertically on mobile */
  }

  .stat-box {
    background: var(--bg-body);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    text-align: center;
  }
  .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
  .stat-value { font-size: 24px; font-weight: 700; color: var(--primary); margin-top: 4px; font-variant-numeric: tabular-nums; }
  .stat-unit { font-size: 13px; color: var(--text-muted); }

  /* Sensors */
  .sensor-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 24px; }
  .sensor-pill {
    background: var(--bg-surface);
    padding: 8px 4px; border-radius: 6px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 500; text-align: center;
    border: 1px solid transparent;
  }
  .sensor-pill.active { background: rgba(16, 185, 129, 0.15); color: var(--success); border-color: rgba(16, 185, 129, 0.3); }

  /* Button Logic */
  button {
    background: var(--btn-bg);
    color: var(--btn-text);
    border: 1px solid var(--border);
    padding: 10px 16px; /* Larger touch target */
    border-radius: 8px;
    font-size: 13px; font-weight: 600;
    cursor: pointer;
    display: inline-flex; align-items: center; gap: 6px; justify-content: center;
    transition: all 0.2s;
    user-select: none;
  }
  button:active { transform: scale(0.98); }

  button.primary { background: var(--primary); color: white; border: none; }
  button.success { background: var(--success); color: white; border: none; }
  button.danger { background: var(--danger); color: white; border: none; }
  button.icon-only { padding: 8px 12px; }

  /* MEDIA QUERY: Touch-friendly buttons on mobile */
  @media (max-width: 480px) {
    button {
      padding: 12px 16px; /* Even larger touch targets on mobile */
      min-height: 44px; /* Minimum touch target size */
    }
    
    button.icon-only {
      padding: 10px 12px;
      min-height: 44px;
    }
  }

  /* Controls Grid Layout */
  .controls-wrapper {
    display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
  }
  @media (max-width: 600px) {
    .controls-wrapper { grid-template-columns: 1fr; } /* Stack buttons on mobile */
  }

  .control-group { background: var(--bg-surface); padding: 12px; border-radius: 8px; }
  .group-label { font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin-bottom: 10px; }
  .btn-row { display: flex; gap: 8px; }

  /* Inputs & Forms */
  input[type="number"], input[type="text"] {
    width: 100%; padding: 10px; /* Touch friendly padding */
    background: var(--input-bg);
    border: 1px solid var(--border);
    color: var(--text-main);
    border-radius: 6px;
    font-size: 16px; /* Prevents iOS zoom on focus */
  }

  /* MEDIA QUERY: Better mobile inputs */
  @media (max-width: 480px) {
    input[type="number"], input[type="text"] {
      padding: 12px; /* Larger touch area */
      min-height: 44px; /* Minimum touch target */
    }
  }

  /* Checkbox styling */
  .checkbox-wrap { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 4px 0; }
  .checkbox-wrap input { width: 18px; height: 18px; accent-color: var(--primary); }

  /* Responsive Table */
  .table-container { 
    max-height: 300px; 
    overflow-y: auto; 
    /* Horizontal Scroll for mobile tables */
    overflow-x: auto; 
    border: 1px solid var(--border); 
    border-radius: 8px; 
    -webkit-overflow-scrolling: touch;
  }
  table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 400px; /* Force scroll on tiny screens */ }
  th { background: var(--bg-surface); padding: 10px; text-align: left; position: sticky; top: 0; color: var(--text-muted); white-space: nowrap; }
  td { padding: 10px; border-bottom: 1px solid var(--border); color: var(--text-main); }

  /* MEDIA QUERY: Better table readability on mobile */
  @media (max-width: 480px) {
    .table-container {
      font-size: 12px; /* Slightly smaller font for mobile */
    }
    
    th, td {
      padding: 8px 6px; /* More compact padding */
    }
  }

  /* Settings Fieldset */
  .setting-item { margin-bottom: 14px; }
  .setting-item label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
  fieldset { border: none; padding: 0; margin: 0; }
  fieldset:disabled { opacity: 0.5; pointer-events: none; }

  /* Canvas Wrapper */
  .chart-wrapper { position: relative; height: 220px; width: 100%; margin-top: 10px; }

  /* Status Badge */
  .status-badge { 
    display: inline-flex; align-items: center; 
    font-size: 12px; font-weight: 600; 
    padding: 6px 12px; border-radius: 20px;
    background: var(--bg-surface);
    white-space: nowrap;
  }
  .status-badge.connected { color: var(--success); background: rgba(16, 185, 129, 0.1); }
  .status-badge.disconnected { color: var(--danger); background: rgba(239, 68, 68, 0.1); }
  .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }

  /* Warning Modal */
  .modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
    display: none; align-items: center; justify-content: center; z-index: 999;
    padding: 20px;
  }
  .modal-box {
    background: var(--bg-card); padding: 24px; border-radius: 12px; width: 100%; max-width: 400px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); border: 1px solid var(--border);
  }

  /* MEDIA QUERY: Better modal on mobile */
  @media (max-width: 480px) {
    .modal-overlay {
      padding: 16px;
    }
    
    .modal-box {
      padding: 20px;
    }
  }

  footer { text-align: center; font-size: 12px; color: var(--text-muted); margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border); }
</style>
</head>
<body>

<div class="wrap" id="app">
  
  <header>
    <div class="brand">
      <div class="brand-row">
        <h1>Viscometer</h1>
        <span class="badge">PRO</span>
      </div>
      <div class="subtitle">WiFi: <b>ESP32-Viscometer</b></div>
    </div>
    
    <div class="controls-top">
      <div id="connectionStatus" class="status-badge disconnected">
        <span class="status-dot" style="background:currentColor"></span> Offline
      </div>
      <button class="icon-only" id="themeBtn" style="min-width: 40px;">üåô</button>
    </div>
  </header>

  <div class="main-grid">
    
    <div class="col-main">
      
      <div class="card">
        <div class="card-header">
          <div class="card-title">üìä Live Data</div>
          <button id="btn-reload" class="icon-only" title="Refresh Page">‚Üª</button>
        </div>

        <div class="stats-row">
          <div class="stat-box">
            <div class="stat-label">Temperature</div>
            <div id="temp" class="stat-value">--</div>
            <div class="stat-unit">¬∞C</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Fall Time</div>
            <div id="time" class="stat-value">--</div>
            <div class="stat-unit">seconds</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Viscosity (Œº)</div>
            <div id="visc" class="stat-value">--</div>
            <div class="stat-unit">Pa¬∑s</div>
          </div>
        </div>

        <div class="sensor-row">
          <div id="s1" class="sensor-pill">Top Sensor</div>
          <div id="s2" class="sensor-pill">Bottom Sensor</div>
          <div id="laserState" class="sensor-pill">Laser System</div>
        </div>

        <div class="controls-wrapper">
          <div class="control-group">
            <div class="group-label">Measurement</div>
            <div class="btn-row">
              <button id="start" class="success" style="flex:1">Start</button>
              <button id="stop" class="danger" style="flex:1">Stop</button>
            </div>
          </div>
          <div class="control-group">
            <div class="group-label">Laser</div>
            <div class="btn-row">
              <button id="laserOn" class="primary" style="flex:1">On</button>
              <button id="laserOff" style="flex:1">Off</button>
            </div>
          </div>
        </div>

        <div style="margin-top: 24px;">
          <div class="group-label">Realtime Trend</div>
          <div class="chart-wrapper">
            <canvas id="chartCanvas"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">üìã Run Logs</div>
          <div class="btn-row">
            <button id="btn-download" class="primary" style="font-size:12px;">üì• CSV</button>
            <button id="clearLog" class="danger icon-only">üóëÔ∏è</button>
          </div>
        </div>
        <div class="table-container">
          <table id="logTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Temp (¬∞C)</th>
                <th>Time (s)</th>
                <th>Viscosity (Pa¬∑s)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-sidebar">
      
      <div class="card">
        <div class="card-title" style="margin-bottom:12px;">üßÆ Data Averaging</div>
        <div style="display:flex; flex-direction: column; gap: 12px;">
           <label class="checkbox-wrap">
              <input id="avgEnable" type="checkbox"/>
              <span>Enable Averaging</span>
            </label>
            <div style="display:flex; gap:8px;">
              <input id="avgCount" type="number" value="5" min="2" placeholder="Samples"/>
              <button id="avgSet" class="primary">Set</button>
            </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">‚öôÔ∏è Calibration</div>
          <button id="openUpdate" class="warning" style="font-size:11px; padding:4px 8px;">OTA</button>
        </div>

        <label class="checkbox-wrap" style="margin-bottom:16px;">
          <input id="useCustom" type="checkbox"/>
          <span>Use Custom Values</span>
        </label>

        <fieldset id="settingsField">
          <div class="setting-item">
            <label>Ball Density (kg/m¬≥)</label>
            <input id="ballDensity" type="number" step="1" />
          </div>
          <div class="setting-item">
            <label>Ball Diameter (m)</label>
            <input id="ballDiameter" type="number" step="0.0001" />
          </div>
          <div class="setting-item">
            <label>Liquid Density (kg/m¬≥)</label>
            <input id="liquidDensity" type="number" step="0.1" />
          </div>
          <div class="setting-item">
            <label>Tube Inner Dia (m)</label>
            <input id="tubeDiameter" type="number" step="0.0001" />
          </div>
          <div class="setting-item">
            <label>Sensor Distance (m)</label>
            <input id="sensorDistance" type="number" step="0.001" />
          </div>
          <div class="setting-item">
            <label>Gravity (m/s¬≤)</label>
            <input id="gravity" type="number" step="0.0001" />
          </div>
           <div class="setting-item">
            <label>DHT Pin</label>
            <input id="dhtPin" type="number" step="1" />
          </div>
        </fieldset>

        <div style="margin-top: 20px; display:flex; flex-direction: column; gap: 10px;">
          <button id="saveSettings" class="primary" style="width:100%; padding:12px;">üíæ Save to ESP32</button>
          <button id="useDefaults" style="width:100%">‚Ü© Restore Defaults</button>
        </div>
      </div>
    </div>

  </div> <footer>
    <p>Fluid Mechanics Lab ¬∑ 2025</p>
  </footer>

</div>

<div id="warningModal" class="modal-overlay">
  <div class="modal-box">
    <h3 style="margin-top:0; color:var(--danger)">‚ö†Ô∏è System Warning</h3>
    <p id="warningMessage" style="color:var(--text-muted); margin-bottom: 20px;">Sensor Error</p>
    <button id="modalClose" class="primary" style="width:100%">Acknowledge</button>
  </div>
</div>

<script>
/* LOGIC SECTION
   -------------
   No logic changes were made, only UI/CSS responsiveness.
*/
const wsUrl = `ws://${location.hostname}/ws`;
let ws;
let runCounter = 1;
let chartPoints = [];
const MAX_POINTS = 50; 

const defaultSettings = {
  ballDensity: 6520, ballDiameter: 0.0254, liquidDensity: 1260,
  tubeDiameter: 0.04, sensorDistance: 0.096, gravity: 9.8, dhtPin: 4, isCustom: false
};

// Theme Toggle
const themeBtn = document.getElementById('themeBtn');
function applyTheme(name) {
  if (name === 'light') document.body.classList.add('light');
  else document.body.classList.remove('light');
  localStorage.setItem('visco_theme', name);
  themeBtn.textContent = name === 'light' ? '‚òÄÔ∏è' : 'üåô';
}
themeBtn.onclick = () => {
  const cur = localStorage.getItem('visco_theme') || 'dark';
  applyTheme(cur === 'dark' ? 'light' : 'dark');
};
applyTheme(localStorage.getItem('visco_theme') || 'dark');

// Helpers
function send(obj){ if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(obj)); }

function updateStatus(message, type){
  const el = document.getElementById('connectionStatus');
  el.className = 'status-badge ' + type;
  el.innerHTML = `<span class="status-dot" style="background:currentColor"></span> ${message}`;
}

const modal = document.getElementById('warningModal');
function showWarningModal(msg){
  document.getElementById('warningMessage').textContent = msg;
  modal.style.display = 'flex';
}
document.getElementById('modalClose').onclick = () => modal.style.display = 'none';

// Websocket
function connectWS(){
  try { ws = new WebSocket(wsUrl); } 
  catch(err) { setTimeout(connectWS,1500); return; }
  
  ws.onopen = () => { updateStatus('Online', 'connected'); send({type:'getSettings'}); };
  ws.onclose = () => { updateStatus('Offline', 'disconnected'); setTimeout(connectWS,1500); };
  ws.onerror = () => { updateStatus('Error', 'disconnected'); };
  
  ws.onmessage = (evt) => {
    try { handleMsg(JSON.parse(evt.data)); } catch(e) {}
  };
}
connectWS();

function handleMsg(d){
  if (!d.type) return;
  if (d.type === 'update'){
    document.getElementById('temp').textContent = (d.temp == null) ? '--' : d.temp.toFixed(2);
    document.getElementById('time').textContent = (d.time == null) ? '--' : d.time.toFixed(4);
    document.getElementById('visc').textContent = (d.visc == null) ? '--' : d.visc.toExponential(2);

    updateSensor('s1', d.sensor1);
    updateSensor('s2', d.sensor2);
    updateSensor('laserState', d.laserOn);

    if (d.warning1 || d.warning2){
      let msg = (d.warning1 ? 'Top Sensor Lost. ' : '') + (d.warning2 ? 'Bottom Sensor Lost.' : '');
      showWarningModal(msg);
    }
  } else if (d.type === 'log') {
    addLogRow(d.temp, d.time, d.visc);
  } else if (d.type === 'settings') {
    fillSettings(d);
  }
}

function updateSensor(id, isActive){
  const el = document.getElementById(id);
  if(isActive) el.classList.add('active'); else el.classList.remove('active');
}

// Events
document.getElementById('start').onclick = ()=> send({type:'startMeasurement'});
document.getElementById('stop').onclick = ()=> send({type:'stopMeasurement'});
document.getElementById('laserOn').onclick = ()=> send({type:'laserOn'});
document.getElementById('laserOff').onclick = ()=> send({type:'laserOff'});
document.getElementById('btn-reload').onclick = ()=> location.reload();
document.getElementById('clearLog').onclick = ()=> { 
  document.querySelector('#logTable tbody').innerHTML=''; 
  chartPoints=[]; drawChart(); runCounter=1; 
};

// Download CSV
document.getElementById('btn-download').onclick = () => {
  const rows = document.querySelectorAll('#logTable tbody tr');
  let csv = 'Run,Temp(C),Time(s),Viscosity(Pa.s)\n';
  rows.forEach(r => {
    const cols = r.querySelectorAll('td');
    csv += Array.from(cols).map(c => c.textContent).join(',') + '\n';
  });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
  a.download = 'viscometer_data.csv';
  document.body.appendChild(a); a.click(); a.remove();
};

document.getElementById('saveSettings').onclick = () => {
  const getVal = (id) => parseFloat(document.getElementById(id).value);
  send({
    type: 'setSettings',
    ballDensity: getVal('ballDensity'), ballDiameter: getVal('ballDiameter'),
    liquidDensity: getVal('liquidDensity'), tubeDiameter: getVal('tubeDiameter'),
    sensorDistance: getVal('sensorDistance'), gravity: getVal('gravity'),
    dhtPin: parseInt(document.getElementById('dhtPin').value),
    isCustom: document.getElementById('useCustom').checked
  });
  const btn = document.getElementById('saveSettings');
  const oldText = btn.textContent;
  btn.textContent = 'Saved ‚úì'; btn.style.background = 'var(--success)';
  setTimeout(()=>{ btn.textContent = oldText; btn.style.background = ''; }, 1500);
};

document.getElementById('useDefaults').onclick = ()=> {
  send({type:'useDefaults'});
  document.getElementById('useCustom').checked = false;
  fillSettings(defaultSettings);
};

document.getElementById('useCustom').onchange = (e)=> {
  document.getElementById('settingsField').disabled = !e.target.checked;
  if (e.target.checked) send({type:'getSettings'}); else send({type:'useDefaults'});
};

document.getElementById('avgSet').onclick = () => {
  send({ type:'setAveraging', enabled: document.getElementById('avgEnable').checked, count: parseInt(document.getElementById('avgCount').value || 5) });
  const btn = document.getElementById('avgSet');
  btn.textContent = '‚úì';
  setTimeout(()=>{ btn.textContent = 'Set'; }, 1000);
};

document.getElementById('openUpdate').onclick = ()=> window.open('/update', '_blank');

function fillSettings(s){
  const set = Object.assign({}, defaultSettings, s);
  for (const k in set) {
    if(document.getElementById(k)) document.getElementById(k).value = set[k];
  }
  document.getElementById('useCustom').checked = !!set.isCustom;
  document.getElementById('settingsField').disabled = !set.isCustom;
}

function addLogRow(temp, time, visc){
  const row = document.createElement('tr');
  row.innerHTML = `<td>${runCounter++}</td><td>${temp?.toFixed(2)}</td><td>${time?.toFixed(4)}</td><td>${visc?.toExponential(3)}</td>`;
  document.querySelector('#logTable tbody').prepend(row);
  
  chartPoints.push(visc || 0);
  if (chartPoints.length > MAX_POINTS) chartPoints.shift();
  drawChart();
}

// Responsive Chart
const canvas = document.getElementById('chartCanvas');
const ctx = canvas.getContext('2d');

function drawChart(){
  const wrapper = canvas.parentElement;
  const w = canvas.width = wrapper.clientWidth;
  const h = canvas.height = wrapper.clientHeight;
  ctx.clearRect(0,0,w,h);

  if (chartPoints.length < 2) {
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-muted');
    ctx.font = '13px Inter'; ctx.fillText("Waiting for data...", 10, 20);
    return;
  }

  const max = Math.max(...chartPoints, 0.0001); 
  const min = Math.min(...chartPoints);
  const range = max - min || 1;
  const stepX = w / (chartPoints.length - 1);

  // Gradient
  const gradient = ctx.createLinearGradient(0, 0, 0, h);
  const color = getComputedStyle(document.body).getPropertyValue('--primary').trim();
  gradient.addColorStop(0, color.replace(')', ', 0.2)').replace('rgb', 'rgba'));
  gradient.addColorStop(1, color.replace(')', ', 0.0)').replace('rgb', 'rgba'));

  ctx.beginPath();
  chartPoints.forEach((val, i) => {
    const x = i * stepX;
    const y = h - ((val - min) / range) * (h - 20) - 10;
    if (i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  
  ctx.lineJoin = 'round';
  ctx.lineWidth = 2;
  ctx.strokeStyle = color;
  ctx.stroke();

  ctx.lineTo(w, h);
  ctx.lineTo(0, h);
  ctx.fillStyle = gradient;
  ctx.fill();
}
window.addEventListener('resize', drawChart);

fillSettings(defaultSettings);
drawChart();
</script>
</body>
</html>